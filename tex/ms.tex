% Replace "([a-z$,])\n(\s*)([$\(a-z])" with "$1 $3"
% Replace "\.\s([a-z])" with ". \n$1"
% Define document class & import showyourwork
\documentclass[modern]{aastex631}

\include{style}

% Begin!
\begin{document}

% Title
\title{A Closed-Form Solution to the Doppler Imaging Problem}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{Megan Bedell}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{Daniel Foreman-Mackey}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{David W. 
Hogg}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}

\begin{abstract}
    We derive a closed form, analytic solution to the problem of Doppler imaging of stellar surfaces in the limit of negligible differential rotation and convective blueshift.
    The model for the observed spectrum is linear in the coefficients of the spherical harmonic expansion of the specific intensity distribution on the surface and, in certain limits, the posterior over surface maps has a closed form, analytic solution that is computationally trivial to evaluate.
    The model is also linear in the local (rest frame) stellar spectrum, which may itself be spatially variable.
    This allows one to perform Doppler imaging without knowledge of the local stellar spectrum and therefore works on blended lines or regions of the spectrum where line formation mechanisms are not well understood.
    Finally, the model is fast, differentiable, and allows one to calculate uncertainties on the inferred surface map.
\end{abstract}

% Main body
\section{Introduction}
The paper is organized as follows: in \S\ref{sec:the_problem}~and~\S\ref{sec:the_solution} we introduce the math behind the Doppler imaging problem and derive a closed form expression for the model. 
In \S\ref{sec:linear},~\S\ref{sec:inverse},~and~\S\ref{sec:bellswhistles} we demonstrate how to re-express the model as a linear operation on the input spectrum and stellar map and derive closed form expressions for the two conditioned on the data and priors.
In \S\ref{sec:spotstar} we apply our techniques to a mock problem. 
We further discuss and summarize our results in \S\ref{sec:discussion}~and~\S\ref{sec:conclusions}. 
Finally, auxiliary derivations are presented in the Appendix.

\section{The problem}
\label{sec:the_problem}
%
Let $I(\lnlam, \x, t, \Dargs)$ be the specific intensity observed at log wavelength $\lnlam \equiv \ln\frac{\lambda}{\lambda_\mathrm{r}}$ and at sky-projected Cartesian position $\x = (x, y, z)$ on the surface of the star at time $t$, where $\Dargs$ is a set of arbitrary parameters of the Doppler field and $\lambda_\mathrm{r}$ is a reference wavelength.
We may express this intensity as
%
\begin{align}
    \label{eq:the_problem:Ixi}
    I(\lnlam, \x, t, \Dargs) & =
    I\Big(\lnlam_0 + \D(\x, \Dargs), \x, t\Big)
\end{align}
%
where $\lnlam_0$ is the log wavelength in the rest frame and $\D$ is the Doppler shift in log wavelength space:
%
\begin{align}
    \label{eq:the_problem:D}
    \D(\x, \Dargs)
     & =
    \frac{1}{2}\ln\left(
    \frac{1 + \beta(\x, \Dargs)}{1 - \beta(\x,
            \Dargs)}
    \right)
\end{align}
%
where $\beta = v(\x, \Dargs) / c$ is the ratio of the radial velocity at a point on the surface of the star to the speed of light.
In keeping with the literature, we take positive values of $v$ (and $\D$) to mean redshifts.

A common approach to computing the Doppler-shifted spectrum is to evaluate the spectrum at the rest frame wavelength $\lnlam_0$ and interpolate back to the grid in $\lnlam$. 
This is practical when computing the spectrum at a single \emph{point} on the surface, but not ideal when one is interested in the \emph{integral} over the visible surface of the star $\Surf$, which is typically all we can observe:
%
\begin{align}
    \label{eq:the_problem:F}
    F(\lnlam, t, \Dargs)
     & \equiv
    \iint\limits_{\Surf(\x)}
    I(\lnlam, \x, t, \Dargs)
    \mathrm{d}{\Surf(\x)}
    \quad ,
\end{align}
%
The difficulty in solving Equation~(\ref{eq:the_problem:F}) stems from the fact that $I(\lnlam, \x, t, \Dargs)$ is difficult to write down in closed form, given the nonlinearity of the Doppler shift.
The standard approach to solving this integral is therefore to discretize the surface of the star with a fine grid, evaluate the Doppler-shifted spectrum in each cell, and sum over the spatial axes to approximate the integral. 
Depending on the resolution of the grid, this is either numerically inaccurate or computationally inefficient (and often both).

\section{The Solution}
\label{sec:the_solution}

\subsection{Doppler Deconvolution}

The observed spectrum is a complex function of spatial, spectral, temporal, and velocity terms. 
The goal in this section is to deconvolve each of these terms to make solving the integral in Equation~(\ref{eq:the_problem:F}) easier.
%
The first thing we will do is to express Equation~(\ref{eq:the_problem:Ixi})
as a convolution:
%
\begin{align}
    \label{eq:deconv:convolution}
    I(\lnlam, \x, t, \Dargs) & =
    I(\lnlam_0, \x, t)
    *
    \delta\big(\lnlam_0 + \D(\x, \Dargs)\big)
\end{align}
%
where $\delta$ is the Dirac delta function and $*$ denotes the linear convolution operator, defined for two arbitrary functions $g$ and $h$ as the integral
%
\begin{align}
    \label{eq:deconv:convolution_def}
    (g * h)(t) \equiv \int_{-\infty}^\infty g(\tau) h(t - \tau) d\tau
\end{align}
%
for some independent coordinate $t$ and dummy parameter $\tau$.
%
The convolution of $I(\lnlam_0)$ with a delta function has the effect of shifting the spectrum by an amount $\D$, returning a function of the shifted (observed) log wavelength, $\lnlam = \lnlam_0 + \D$.

Next, we expand the spatial dependence of the specific intensity at the rest frame wavelength in terms of spherical harmonics on the unit disk:
%
\begin{align}
    \label{eq:deconv:Ixi0}
    I(\lnlam_0, \x, t)
     & =
    \sum_{l=0}^{l_\mathrm{max}}\sum_{m=-l}^{l} a_{lm}(\lnlam_0, t) Y_{lm}(\x)
    \quad ,
\end{align}
%
where $Y_{lm}(\x)$ is a spherical harmonic on the projected disk and $a_{lm}(\lnlam_0, t)$ is the corresponding spherical harmonic coefficient at log wavelength in the rest frame $\lnlam_0$ and time $t$. 
For convenience, we may write this equation in vector form:
%
\begin{align}
    \label{eq:deconv:Ivec}
    I(\lnlam_0, \x, t) & =
    \ylmbasis(\x) \,
    \alm(\lnlam_0, t)
    \quad ,
\end{align}
%
where
%
\begin{align}
    \label{eq:deconv:alm}
    \alm(\lnlam_0, t) \equiv
    \Big(
    a_{0,0}(\lnlam_0, t) \quad 
    a_{1,-1}(\lnlam_0, t) \quad 
    a_{1,0}(\lnlam_0, t) \quad 
    a_{1,1}(\lnlam_0, t) \quad
    ...
    \Big)^\top
\end{align}
%
is the vector of $N = (l_\mathrm{max} + 1)^2$ spherical harmonic coefficients and
%
\begin{align}
    \label{eq:deconv:ylmbasis}
    \ylmbasis(\x) \equiv
    \Big(
    Y_{0,0}(\x) \quad 
    Y_{1,-1}(\x) \quad 
    Y_{1,0}(\x) \quad 
    Y_{1,1}(\x) \quad
    ...
    \Big)
\end{align}
%
is the corresponding vector of $N$ spherical harmonics. 
We may further decompose our expression by linearizing the time dependence of the spherical harmonic coefficients:
%
\begin{align}
    \label{eq:deconv:R}
    \alm(\lnlam_0, t) = \R(t) \, \azero(\lnlam_0)
    \quad ,
\end{align}
%
where $\azero(\lnlam_0) = \bvec{a}(\lnlam_0, t=t_0)$ for some reference time $t_0$.
For rigid body rotation, the result is exact and $\R(t)$ is the $(N \times N)$ Wigner rotation matrix for real spherical harmonics
\citep[e.g.][]{AlvarezCollado1989}, which is implicitly a function of the inclination, obliquity, and rotation period of the star.
%In the case that other processes such as differential rotation or spot 
%evolution are significant
%over the course of an observation, Equation~(\ref{eq:deconv:R}) can be
%made to hold approximately for some effective rotation matrix 
%$\R(t)$; we discuss this later.

The equation for the specific intensity in the rest frame now reads
%
\begin{align}
    \label{eq:deconv:Ivecfull}
    I(\lnlam_0, \x, t) & =
    \ylmbasis(\x)
    \,
    \R(t)
    \,
    \azero(\lnlam_0)
    \quad ,
\end{align}
%
where it is clear that we have fully separated the spatial, temporal, and spectral terms. 
Inserting this into Equation~(\ref{eq:deconv:convolution})
and integrating over the visible portion of the star, we arrive at the expression for the observed spectrum:
%
%
\begin{align}
    \label{eq:deconv:F2d}
    F(\lnlam, t, \Dargs) & =
    \iint\limits_{\Surf(\x)}
    \ylmbasis(\x)
    \,
    \R(t)
    \,
    \alm(\lnlam_0)
    * \delta\big(\lnlam_0 + \D(\x, \Dargs)\big)
    \mathrm{d}\Surf(\x)
    \nonumber                \\[0.5em]
                         & =
    \iint\limits_{\Surf(\x)}
    \ylmbasis(\x)
    \delta\big(\lnlam_0 + \D(\x, \Dargs)\big)
    \mathrm{d}\Surf(\x)
    \,
    \R(t)
    \,
    *
    \,
    \azero(\lnlam_0)
    \quad ,
\end{align}
%
%
where we made use of the commutativity of the convolution operator and the fact that the integral is taken only over the spatial dimensions.
Note, importantly, that the convolution operation above is implicitly a vector operation---i.e., the convolution is taken for each spherical harmonic term individually and then summed over all terms.

Finally, we can simplify Equation~(\ref{eq:deconv:F2d}) by noting that the delta function in the integrand allows us to reduce the double integral to a line integral:
%
\begin{align}
    \label{eq:deconv:kT}
    \iint\limits_{\Surf(\x)}
    \ylmbasis(\x)
    \delta\big(\lnlam_0 + \D(\x, \Dargs)\big)
    \mathrm{d}\Surf(\x)
    \, \,
     & =
    \int\limits_{\Curve(\lnlam, \x, \Dargs)}
    \hspace*{-0.6em}\ylmbasis(\x)
    \mathrm{d}\Curve(\lnlam, \x, \Dargs)
    \nonumber                     \\[0.5em]
     & \equiv \kT(\lnlam, \Dargs)
    \quad.
\end{align}
%
where the path $\Curve(\lnlam, \x, \Dargs)$ corresponds to the set of all points on the visible disk where $\lnlam_0 + \D(\x, \Dargs) = 0$.
%
We thus have
%
\begin{align}
    \label{eq:deconv:F}
    F(\lnlam, t, \Dargs)
     & =
    \kT(\lnlam, \Dargs) \, \R(t)
    *
    \azero(\lnlam_0)
    \quad.
\end{align}
%
Equation~(\ref{eq:deconv:F}) is the deconvolution of the observed spectrum into velocity terms, temporal terms, and spectral/spatial terms, respectively. 
In the next section, we will discuss how to efficiently solve the line integral in Equation~(\ref{eq:deconv:kT}).

\subsection{Computing the kernel $\kT$}
\label{sec:kT}
%
In the case that the star's rotation is rigid (i.e., differential rotation is negligible) and other effects such as convective blueshift may be ignored, the radial velocity at any point on the surface is simply proportional to the distance to the axis of rotation. 
Without loss of generality, if we assume the axis of rotation lies along the $y-z$ plane, we have
%
\begin{align}
    \label{eq:kT:beta}
    \beta(\x, \Dargs) = \frac{\omega \sin i \, x}{c}
\end{align}
%
and
%
\begin{align}
    \label{eq:kT:D}
    \D(\x, \Dargs) & =
    \frac{1}{2}\ln\left(
    \dfrac{1 + \dfrac{\omega \sin i \, x}{c}}
    {1 - \dfrac{\omega \sin i \, x}{c}}
    \right)
    \quad ,
\end{align}
%
where the parameters $\Dargs$ of the Doppler field are the angular velocity, $\omega$, and the inclination of the star with respect to $\hat{y}$, $i$.

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=\linewidth]{kT.pdf}
        \caption{%
            The Doppler $\kT$ basis for a rigidly rotating star computed from Equation~(\ref{eq:kT:kT}) and Equation~(\ref{eq:kT:sTrecurrence}) up to spherical harmonic degree $l_\mathrm{max}=10$. 
            Rows correspond to the degree $l$ and columns correspond to the order $m$. 
            These functions encode the contribution of each spherical harmonic to the rotational broadening of features in the stellar spectrum. 
            Because the rotational axis is chosen to be aligned with $\hat{y}$, none of the $m < 0$ harmonics contribute to the observed spectrum.
        }
        \label{fig:kT}
    \end{centering}
\end{figure}

If we assume the star is unocculted, the region of integration $\Surf(\x)$ in Equation~(\ref{eq:deconv:kT}) is simply the unit disk, so $\Curve(\lnlam, \x, \Dargs)$ is the set of all points that satisfy both $\lnlam_0 + \D(\x, \Dargs) = 0$ and $x^2 + y^2 \le 1$.
Solving Equation~(\ref{eq:kT:D}) for $x$, we find that the curves $\Curve(\lnlam, \x, \Dargs)$ are simply vertical lines on the unit disk given by
%
\begin{align}
    x & =
    \Bigg(\frac{c}{\omega\sin i}\Bigg)
    \Bigg(\frac{\mathrm{e}^{-2{\lnlam_0}} - 1}
    {\mathrm{e}^{-2{\lnlam_0}} + 1}\Bigg)
    \quad .
\end{align}
%
The integral in Equation~(\ref{eq:deconv:kT}) is therefore just the line integral of the spherical harmonic basis over $y$:
%
\begin{align}
    \label{eq:kT:kT}
    \kT(\lnlam, \Dargs)
     & =
    \int\limits_{-\sqrt{1 - x^2}}^
    {\sqrt{1 - x^2}}
    \ylmbasis
    \Big(x, y\Big)
    \mathrm{d}y
    \quad .
\end{align}
%
In the Appendix we derive an analytic solution to this integral and show how to recursively solve it for all terms in the spherical harmonic basis.
Figure~\ref{fig:kT} shows the $\kT$ basis computed from the formulae above and Equation~(\ref{eq:kT:kT}) up to spherical harmonic degree $l_\mathrm{max}=10$.

This completes our derivation of the analytic expression for the observed spectrum (Equation~\ref{eq:deconv:F}).

\subsection{Example}
%
Figure~\ref{fig:spot} shows an example application of the formulae derived in this section. 
We used \starry to generate a synthetic stellar surface with a single large Gaussian spot at a latitude of $30^\circ$, yielding a vector of spherical harmonic coefficients $\bvec{y}$.
The stellar rest frame spectrum $I(\lnlam_0)$ is taken to be a single Gaussian absorption line that is spatially constant everywhere save for a multiplicative factor equal to the local spot intensity.
This corresponds to a spectral/spatial expansion vector $\azero(\lnlam_0)$ whose coefficient at degree $l$ and order $m$ is equal to $y_{lm} I(\lnlam_0)$.
In the Figure, we rotated the star about an axis perpendicular to the line of sight (left panel) and computed the observed spectrum using Equation~(\ref{eq:deconv:F}) (center panel). 
The right panel shows the difference between the observed spectrum and the spectrum when the spot is not in view.
The effect of the spot on the absorption line is evident: a ``bump'' that travels from the blueshifted side of to the redshifted side of the line in sync with the change in longitude of the spot. 
This correspondence between line shape residuals and spot location is the cornerstone of the Doppler imaging technique \citep[compare to, e.g., Figures 1 and 4 in][]{Vogt1983}.

\begin{figure}[p!]
    \begin{centering}
        \includegraphics[width=0.6\linewidth]{spot.pdf}
        \caption{%
            Time evolution of a Gaussian absorption line on a rigidly rotating, spotted star computed from the analytic formulae in \S\ref{sec:kT}.
            The stellar surface is modeled as a spherical harmonic expansion up to $l_\mathrm{max}=20$, and the line shape is assumed to be the same everywhere;
            the spot simply downweights the local intensity at all wavelengths.
            As the spot rotates into view (left panel), the line shape changes slightly (center panel). 
            The residuals between the line when the spot is in view (solid) and when it is on the backside of the star (dotted) are shown in the right panel, where a Gaussian-like feature can be seen tracking the spot as it rotates from the blueshifted hemisphere to the redshifted hemisphere of the star.
        }
        \label{fig:spot}
    \end{centering}
\end{figure}

Figure~\ref{fig:compare} shows one of the spectra in Figure~\ref{fig:spot}, this time computed using both our formulae (blue line) and the traditional technique of discretizing the stellar surface, Doppler-shifting the spectrum in each grid cell according to the local radial velocity, interpolating back to a uniform wavelength grid, and summing over the spatial dimension (dotted orange line). 
We show the residuals in the lower panel, where it is clear that as the number of grid cells increases from 2,000 (light grey) to 71,000 (dark grey), the numerical solution approaches the solution obtained using our approach.

%Understand---and comment on---the fundamental
%differences between a discrete linear convolution and traditional linear 
%interpolation. 
Should we expect the numerical solution to actually \emph{converge}
%to the \starry solution, or is the way the two are interpolating fundamentally
%different?

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=0.65\linewidth]{compare.pdf}
        \caption{%
            The observed spectrum when the spot is in view computed with
            \starry (blue) and numerically (orange). 
            The problem setup is the same as that in Figure~\ref{fig:spot}. 
            The boottom panel shows the absolute value of the difference between the two spectra for different number of grid points in the numerical solution.
            As the number of grid points increases, the numerical solution approaches the \starry solution.
        }
        \label{fig:compare}
    \end{centering}
\end{figure}

\section{Linearization}
\label{sec:linear}

\begin{figure}[ht!]
    \begin{centering}
        \includegraphics[width=0.8\linewidth]{linalg.pdf}
        \caption{%
            The Doppler design matrix $\Doppler$ (Equation~\ref{eq:linear:f}), constructed from a grid of Toeplitz matrices, each of shape $K \times K'$, where $K$ is the number of wavelength bins in the observed spectrum and $K' = K + W - 1$ is the number of bins in the model spectrum, where $W$ is the width of the convolution kernel.
            The $N$ columns of $\Doppler$ correspond to the Toeplitz matrices for each of the $N$ spherical harmonics (shown at the top);
            the $M$ rows correspond to the Toeplitz matrices rotated to each of the $M$ stellar phases observed (indicated graphically to the left of $\Doppler$).
        }
        \label{fig:linalg}
    \end{centering}
\end{figure}

Although the convolution operator (Equation~\ref{eq:deconv:convolution_def})
is defined for continuous functions, the problem of Doppler imaging deals with discrete measurements of a spectrum in bins of log wavelength. 
Provided our wavelength grid is fine enough, we may therefore approximate Equation~(\ref{eq:deconv:convolution_def}) with a discrete convolution.
For discrete arrays $\bvec{g}$ and $\bvec{h}$, we have
%
\begin{align}
    \label{eq:linear:convolution_def}
    \bvec{g} * \bvec{h} = \bvec{T(g)} \, \bvec{h}
\end{align}
%
where $\bvec{T}$ is a Toeplitz matrix, a matrix whose diagonals are constant from top left to bottom right. 
In this case, the diagonals are constructed from the values of $\bvec{g}$. 
If $\bvec{g}$ has length $L$, element $g_n$ is placed everywhere along the $k^\mathrm{th}$ diagonal of $\bvec{T}$ for $k = -L / 2 + n$; all other entries of $\bvec{T}$ are set to zero. 
Note that the matrix $\bvec{T}$ need not be square; in fact, for our purposes, it is a $(K \times K')$ matrix, where $K$ is the size of the observed wavelength grid and $K' = K + W - 1$ is the size of the wavelength grid in the rest frame, where $W$ is the width of the convolution kernel.

Given this formulation, we may re-write Equation~(\ref{eq:deconv:F}) as a purely linear operation on $\azero(\lnlam_0)$:
%
\begin{align}
    \label{eq:linear:ft}
    \bvec{f}_m
     & =
    \Doppler_m
    \,
    \azero
    \quad,
\end{align}
%
where $\Doppler_m$ is a $(K \times N K')$ matrix constructed by horizontally concatenating the Toeplitz matrices for each of the $N$ components of the convolution kernel $\kT(\lnlam, \Dargs)$ transformed by the rotation matrix $\bvec{R}(t)$ evaluated at time $t = t_m$:
%
\begin{align}
    \label{eq:linear:Dm}
    \Doppler_m =
    \begin{pmatrix}
        \quad
        \bvec{T}(\kT_0)
        \quad
         &
        \quad
        \bvec{T}(\kT_1)
        \quad
         &
        \quad
        \cdots
        \quad
         &
        \quad
        \bvec{T}(\kT_N)
        \quad
    \end{pmatrix}
    (\bvec{R}(t_m) \otimes \bvec{I}_{K'})
    \quad.
\end{align}
%
where $\bvec{I}_{K'}$ is the $(K' \times K')$ identity matrix and $\otimes$ denotes the Kronecker product.
%
The $(K \times 1)$ vector $\mathbf{f}_m$ is the model for the flux observed at each wavelength at time $t = t_m$, and the $(N K' \times 1)$ vector $\azero$ is the vector representation of the spatially-dependent spectrum of the star. 
The latter is constructed by flattening the spherical harmonic expansion of the star such that the first $K'$ terms in $\azero$ correspond to the the values of $(a_0)_{0,0}$ at each wavelength $\lnlam_0$, followed by the values of $(a_0)_{1,-1}$ at each wavelength, and so forth.

In general, our data will consist of observations made at several epochs, corresponding to different rotational phases of the star.
If we concatenate all $M$ spectra $\bvec{f}_m$ into the $(MK \times 1)$ vector $\bvec{f}$, we may write
%
\begin{align}
    \label{eq:linear:f}
    \bvec{f}
     & =
    \Doppler
    \,
    \azero
    \quad,
\end{align}
%
where $\Doppler$ is the full $(MK \times N K')$ Doppler design matrix, constructed by vertically concatenating the individual matrices $\Doppler_m$:
%
%
\begin{align}
    \label{eq:linear:D}
    \Doppler =
    \begin{pmatrix}
        \Doppler_0
        \\
        \Doppler_1
        \\
        \cdots
        \\
        \Doppler_m
    \end{pmatrix}
    \quad.
\end{align}
%
%
Equation~(\ref{eq:linear:f}) represents the full linearization of the problem, where we have expressed the quantity we can observe, $\bvec{f}$, as a linear operation on the quantity of interest, the spectral/spatial decomposition of the stellar surface, $\azero$. 
Figure~\ref{fig:linalg} shows an example of $\Doppler$.

\section{The inverse problem}
\label{sec:inverse}
%
In the previous section we showed how to express the data vector $\bvec{f}$, a series of spectra obtained at different epochs, as a purely linear operation on the map vector $\azero$, the spherical harmonic decomposition of the specific intensity on the surface of the star. 
The advantage of this linearity is that, given suitable priors, it allows one to compute both the maximum likelihood solution for $\azero$ and its uncertainty \emph{analytically}. 
In particular, if one places a (multidimensional) Gaussian prior on $\azero$ with mean $\boldsymbol{\mu}_\mathbf{a_0}$ and covariance $\boldsymbol{\Lambda}_\mathbf{a_0}$, the maximum \emph{a posteriori} (MAP)
solution for $\azero$ is
%
\begin{align}
    \label{eq:inverse:ahat}
    \bvec{\hat{a}_0} & =
    \boldsymbol{\Sigma}_\mathbf{\hat{a}_0}
    \left(
    \Doppler^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \bvec{f}
    +
    {\boldsymbol{\Lambda}_{\azero}}^{-1} \boldsymbol{\mu}_\mathbf{a_0}
    \right)
    \quad,
\end{align}
%
with posterior covariance given by
%
\begin{align}
    \label{eq:inverse:acov}
    \boldsymbol{\Sigma}_\mathbf{\hat{a}_0} & =
    \left(
    \Doppler^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \Doppler
    +
    {\boldsymbol{\Lambda}_{\azero}}^{-1}
    \right)^{-1}
    \quad,
\end{align}
%
where $\boldsymbol{\Sigma}_\mathbf{f}$ is the data covariance matrix. 
These equations require the inversion of a few fairly large matrices, but as we will see later, it allows one to obtain the map of the star ($\bvec{\hat{a}_0}$) and its uncertainty ($\boldsymbol{\Sigma}_{\mathbf{\hat{a}_0}}$) in under a second for a typical dataset.

There is, however, a catch: for most practical purposes, it is difficult to find a good Gaussian prior for $\bvec{a_0}$. 
Usually we will have some prior information on what the spectrum of the star is, and perhaps some prior information on the distribution of surface features such as starspots. 
The problem is that even if these priors are Gaussian, the corresponding prior on $\bvec{a_0}$ is \emph{not}. 
To understand this, consider the case where the stellar rest frame spectrum is spatially constant, save for an amplitude that is spatially variable. 
We can then describe the rest frame spectrum by the $(K' \times 1)$ vector $\bvec{s}$ and the amplitude by the $(N \times 1)$ vector $\bvec{y}$ representing the spherical harmonic expansion of the intensity profile of the star. 
The vector $\azero$ is then given by the (flattened) outer product of the two vectors:
%
\begin{align}
    \label{eq:inverse:azero}
    \azero & = \mathrm{vec}\left( \bvec{A_0} \right) \nonumber             \\
           & = \mathrm{vec}\left( \bvec{s} \, \bvec{y}^\top \right) \quad,
\end{align}
%
where $\mathrm{vec}$ denotes the vectorization operation, which in this case transforms the $(K' \times N)$ matrix $\bvec{A_0}$ into the $(N K' \times 1)$ column vector $\azero$ by vertically stacking all of its columns. 
In other words, the vector $\azero$ consists of the set of $K'$ intensities in each wavelength bin repeated $N$ times, each time multiplied by the $n^\mathrm{th}$ spherical harmonic coefficient in the expansion of the surface intensity. 
Returning to our point about priors, note that all of the entries of $\azero$ are the product of two independent random variables. 
Since the product of two random variables is generally non-Gaussian, even when the variables themselves are Gaussian%
\footnote{see, e.g., \url{http://mathworld.wolfram.com/NormalProductDistribution.html}}%
, so too is the prior on $\azero$. 
This point makes Equation~(\ref{eq:inverse:ahat}) of little practical use, since a multivariate Gaussian will not generally be a suitable prior for $\azero$.

That said, a Gaussian prior \emph{is} typically suitable for both the spectrum $\bvec{s}$ and the intensity $\bvec{y}$ (just not their product). 
It is straightforward to show that because Equation~(\ref{eq:linear:f}) is linear in $\azero$, it is also linear in both $\bvec{s}$ and $\bvec{y}$, so MAP solutions can be found analytically for $\bvec{s}$ (conditioned on $\bvec{y}$) and $\bvec{y}$ (conditioned on $\bvec{s}$). 
We investigate these solutions below.

\subsection{Solution for the map}
\label{sec:solve_y}
%
For a fixed, spatially constant rest-frame spectrum $\bvec{s}$, the model for the flux vector may be written as
%
\begin{align}
    \label{eq:inverse:fy}
    \bvec{f}
     & =
    \Doppler
    \,
    \bvec{S}
    \,
    \bvec{y}
    \quad,
\end{align}
%
where
%
\begin{align}
    \label{eq:inverse:S}
    \bvec{S} =
    \begin{pmatrix}
        \quadquad\bvec{s}\quadquad &                            &                            &                            &        \\
                                   & \quadquad\bvec{s}\quadquad &                            &                            &        \\
                                   &                            & \quadquad\bvec{s}\quadquad &                            &        \\
                                   &                            &                            & \quadquad\bvec{s}\quadquad &        \\
                                   &                            &                            &                            & \ddots
    \end{pmatrix}
\end{align}
%
is a $(NK' \times N)$ block matrix constructed by repeating the column vector $\bvec{s}$ $N$ times in blocks along the main diagonal.
Before we solve this equation for $\bvec{y}$, we note that in practice it is convenient to fix the coefficient of the $Y_{0,0}$ spherical harmonic, $y_0$, to unity. 
After all, this coefficient is not directly constrained by the data, as it merely sets the baseline intensity on the surface of the star and is therefore formally degenerate with the stellar luminosity (which also cannot be directly inferred from the data). 
This choice further ensures a mean baseline of unity for the model vector $\mathbf{f}$. 
We may therefore write
%
\begin{align}
    \label{eq:inverse:fy1}
    \bvec{f}
     & =
    \Doppler
    \,
    \bvec{s}_\bvec{0}
    \,
    +
    \,
    \Doppler
    \,
    \bvec{S_1}
    \,
    \bvec{y}_\bvec{1}
    \quad,
\end{align}
%
where the vector $\bvec{s_0}$ denotes the first column of $\bvec{S}$, the matrix $\bvec{S_1}$ denotes the remaining columns of $\bvec{S}$, and $\bvec{y_1}$ is the quantity we wish to solve for: the vector of spherical harmonic coefficients of degree $l \ge 1$.

Given prior mean $\boldsymbol{\mu}_\bvec{y_1}$ and covariance $\boldsymbol{\Lambda}_\bvec{y_1}$ on $\bvec{y_1}$, the MAP solution is given by
%
\begin{align}
    \label{eq:inverse:y1hat}
    \bvec{\hat{y}_1} & =
    \boldsymbol{\Sigma}_\mathbf{\hat{y}_1}
    \left(
    \bvec{S_1}^\top\Doppler^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \left(\bvec{f} - \Doppler\bvec{s}_\bvec{0}\right)
    +
    {\boldsymbol{\Lambda}_\bvec{y_1}}^{-1} \boldsymbol{\mu}_\bvec{y_1}
    \right)
    \quad,
\end{align}
%
with covariance
%
\begin{align}
    \label{eq:inverse:y1cov}
    \boldsymbol{\Sigma}_\bvec{\hat{y}_1} & =
    \left(
    \bvec{S_1}^\top\Doppler^\top
    {\boldsymbol{\Sigma}_\bvec{f}}^{-1}
    \Doppler\bvec{S_1}
    +
    {\boldsymbol{\Lambda}_\bvec{y_1}}^{-1}
    \right)^{-1}
    \quad.
\end{align}
%
If we choose a prior with zero mean ($\boldsymbol{\mu}_\bvec{y_1} = 0$)
and a diagonal covariance that is constant for each spherical harmonic order $m$,
%
\begin{align}
    \boldsymbol{\Lambda}_\bvec{y_1} & =
    \mathrm{diag} \left(
    \sigma_1^2
    \quad\quad\quad\quad
    \sigma_1^2
    \quad\quad\quad\quad
    \sigma_1^2
    \quad\quad\quad\quad
    \sigma_2^2
    \quad\quad\quad\quad
    \sigma_2^2
    \quad\quad\quad\quad
    \sigma_2^2
    \quad\quad\quad\quad
    \sigma_2^2
    \quad\quad\quad\quad
    \sigma_2^2
    \quad\quad\quad\quad
    \cdots
    \right)
    \quad,
\end{align}
%
we are in fact imposing an isotropic prior with an angular power spectrum given by $C_l = \sigma_l^2$
\citep[e.g.,][]{Baldi2006}. 
This is especially useful if the typical angular scale of features on the surface of the star is known or if a Gaussian prior can be placed on it.

\subsection{Solution for the spectrum}
\label{sec:solve_s}
%
If, on the other hand, the spatial intensity profile is known, the model for the flux vector may be written in terms of the spectrum $\bvec{s}$ as
%
\begin{align}
    \label{eq:inverse:fs}
    \bvec{f}
     & =
    \Doppler
    \,
    \bvec{Y}
    \,
    \bvec{s}
    \quad,
\end{align}
%
where
%
\begin{align}
    \label{eq:inverse:Y}
    \bvec{Y} =
    \begin{pmatrix}
        y_0\, \bvec{I}_{K'} \\
        y_1\, \bvec{I}_{K'} \\
        y_2\, \bvec{I}_{K'} \\
        y_3\, \bvec{I}_{K'} \\
        \cdots
    \end{pmatrix}
\end{align}
%
is a $(NK' \times K')$ matrix constructed by vertically stacking $N$ $(K' \times K')$ identity matrices, each multiplied by the corresponding coefficient of $\bvec{y}$. 
Given prior mean $\boldsymbol{\mu}_\mathbf{s}$ and covariance $\boldsymbol{\Lambda}_\mathbf{s}$ on $\mathbf{s}$, the MAP solution is given by
%
\begin{align}
    \label{eq:inverse:shat}
    \bvec{\hat{s}} & =
    \boldsymbol{\Sigma}_\mathbf{\hat{s}}
    \left(
    \bvec{Y}^\top\Doppler^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \bvec{f}
    +
    {\boldsymbol{\Lambda}_\mathbf{s}}^{-1} \boldsymbol{\mu}_\mathbf{s}
    \right)
    \quad,
\end{align}
%
with covariance
%
\begin{align}
    \label{eq:inverse:scov}
    \boldsymbol{\Sigma}_\mathbf{\hat{s}} & =
    \left(
    \bvec{Y}^\top\Doppler^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \Doppler\bvec{Y}
    +
    {\boldsymbol{\Lambda}_\mathbf{s}}^{-1}
    \right)^{-1}
    \quad.
\end{align}

\subsection{The full solution}
\label{sec:full_solve}
%
In the previous two sections we showed how, if the stellar rest-frame spectrum is spatially constant and known \emph{a priori} (from, say, a template spectrum), the posterior distribution for the surface map $\bvec{y}$ is \emph{analytic} (Equations~\ref{eq:inverse:y1hat} and \ref{eq:inverse:y1cov}). 
Conversely, if the surface map is known, the posterior for the spectrum is also analytic (Equations~\ref{eq:inverse:shat} and \ref{eq:inverse:scov}). 
Both sets of solutions require Gaussian priors on the quantities of interest, but these are easily interpretable. 
A Gaussian prior on the spherical harmonic coefficients of the surface map corresponds to the angular power spectrum of the surface features, whereas a Gaussian prior on the spectrum can be used to correctly propagate uncertainties in the stellar spectrum from observational uncertainties on the stellar metallicity, temperature, etc.

Importantly, the framework developed here allows one to analytically compute not only the ``optimal'' solution to the Doppler imaging problem, but also its uncertainty. 
The problem of re-constructing surface images of stars from spectra and/or light curves is fundamentally ill-posed because of intrinsic degeneracies and a large null space \citep[e.g.,][]{Cowan2017,Luger2019}. 
Coupled to uncertainties in the observations themselves, this makes the process of searching for the ``optimal'' solution flawed at best, and meaningless at worst. 
Access to the full covariance matrix of the solution is therefore essential to assessing our confidence in the various features of the inferred surface maps.

However, as we mentioned above, the Doppler imaging problem can be solved analytically for either the surface map or the spectrum, but not both. 
If neither are known exactly \emph{a priori}, which is quite often the case, we can still find the MAP solution quickly by guessing at an initial spectrum $\bvec{s}$ and iterating between optimizing for $\bvec{y}$ and optimizing for $\bvec{s}$. 
This bilinear problem is not generally convex, but given a good starting point for $\bvec{s}$ and sufficient regularization on $\bvec{y}$, we find that it typically converges to the correct solution, especially after refinement with a nonlinear solver; we discuss this in detail below.

Once the MAP solution has been found for both $\bvec{s}$ and $\bvec{y}$, the covariance of one conditioned on the other can be computed from the formulae above. 
However, this is necessarily a lower bound on the true covariance of the solution, since it neglects any covariance \emph{between} $\bvec{s}$ and $\bvec{y}$. 
To \emph{correctly} account for this, one must resort to Monte Carlo methods or other sampling techniques. 
We discuss this further below.

\section{Further considerations}
\label{sec:bellswhistles}
%
Before we demonstrate our formalism in practice, we consider three modifications to our model that are often required when modeling real data. 
Below we discuss what to do when the relative brightness of the star across different observations is unknown (\S\ref{sec:norm}), how to account for the effects of limb darkening (\S\ref{sec:ld}), and how to model stars whose local spectra differ within and outside of starspots (\S\ref{sec:eigen}).

\subsection{Unknown continuum normalization}
\label{sec:norm}
%
Consider the star depicted in Figure~\ref{fig:spot}. 
When the spot is in view, absorption lines become distorted due to the suppression of either blueshifted or redshifted light. 
However, what is not shown in the figure is the fact that overall, the star also gets \emph{dimmer}: the continuum level drops in the presence of the spot. 
Unfortunately, spectrographs are not usually designed to measure this, since the change in the star's overall brightness from one observation to the next is often dwarfed by (unknown) changes in the spectrograph sensitivity.
For this reason, the spectra are usually normalized to have a fixed baseline continuum, and Equation~\ref{eq:linear:f} is no longer a good model for the data.

One option is to collect simultaneous photometry on the target in a band similar to the wavelength range observed, and use this light curve to (un-)normalize the spectral timeseries $\bvec{f}$. 
However, when this is not an option, our model for $\bvec{f}$ (Equation~\ref{eq:linear:f}) must be amended.
%
\begin{align}
    \label{eq:norm:f}
    \bvec{f}
     & =
    \frac{
        \Doppler
        \,
        \azero
    } {
        \bvec{b}
    }
    \quad,
\end{align}
%
where $\bvec{b}$ is the baseline and the vector division is performed elementwise. 
When $\azero$ is given by Equation~(\ref{eq:inverse:azero}), the baseline $\bvec{b}$ is simply the total (wavelength-integrated) flux at each epoch, repeated for every element in each spectrum.
Based on \citet{Luger2019}, this can be computed as a purely linear operation on the spherical harmonic vector $\bvec{y}$:
%
\begin{align}
    \label{eq:norm:b}
    \bvec{b}
     & =
    %
    \begin{pmatrix}
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_0)     \\
        \cdots                                     \\
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_0)     \\
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_1)     \\
        \cdots                                     \\
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_1)     \\
        \cdots                                     \\
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_{M-1}) \\
        \cdots                                     \\
        \bvec{r}^\top \bvec{A_1} \bvec{R}(t_{M-1})
    \end{pmatrix}
    \bvec{y}
    %
    \nonumber \\[0.5em]
     & \equiv
    \bvec{B} \, \bvec{y}
\end{align}
%
where $\bvec{r}$ is given by Equation~(18) in \citet{Luger2019}, $\bvec{A_1}$ is given in Appendix B of \citet{Luger2019}, and $\bvec{R}(t)$ is the rotation matrix defined previously.

Given this new equation, we must change how we approach the inverse problem (\S\ref{sec:inverse}). 
When solving for the spectrum given the spherical harmonic vector (\S\ref{sec:solve_s}), we need only make the replacements $\bvec{f} \rightarrow \frac{\bvec{f}}{\bvec{B}\, \bvec{y}}$ and $\boldsymbol{\Sigma}_\mathbf{f} \rightarrow \frac{\boldsymbol{\Sigma}_\mathbf{f}}{(\bvec{B}\, \bvec{y})^2}$ in Equations~(\ref{eq:inverse:shat}) and (\ref{eq:inverse:scov}).
However, when solving for the spherical harmonic vector given the spectrum (\ref{sec:solve_y}), the problem is no longer linear in $\bvec{y}$, as the vector of interest appears in both the numerator and the denominator:
%
\begin{align}
    \label{eq:norm:fy}
    \bvec{f}
     & =
    \frac{
        \bvec{D}
        \,
        \bvec{S}
        \,
        \bvec{y}
    }{
        \bvec{B}
        \,
        \bvec{y}
    }
    \quad.
\end{align}
%
While we can solve for $\bvec{y}$ using a nonlinear optimizer, it is often the case that the denominator in Equation~(\ref{eq:norm:fy}) is close to unity; i.e., the total flux from the star typically varies by only a few percent. 
When this is the case, it is straightforward to linearize this equation.
Following the notation from \S\ref{sec:solve_y}, we may therefore write
%
\begin{align}
    \bvec{f}
     & =
    \frac{
        \bvec{D} \, \bvec{s_0}
        \,
        +
        \,
        \bvec{D}\bvec{S_1}
        \,
        \bvec{y_1}
    }{
        \bvec{B_0}
        \,
        +
        \bvec{B_1}
        \,
        \bvec{y_1}
    }
    \quad,
\end{align}
%
where $\bvec{B_0} = \bvec{1}$ is the first column of $\bvec{B}$ and $\bvec{B}_\bvec{1}$ denotes the matrix composed from the remaining $N - 1$ columns of $\bvec{B}$.
Expanding the expression above about $\bvec{B_1} \bvec{y_1} = \bvec{0}$ and keeping only terms up to first order, we have
%
\begin{align}
    \label{eq:norm:fapprox}
    \bvec{f}
     & \approx
    \left(
    \bvec{D} \, \bvec{s_0}
    \,
    +
    \,
    \bvec{D}\bvec{S_1}
    \,
    \bvec{y_1}
    \right)
    \circ
    \left(
    \bvec{1}
    \,
    -
    \bvec{B_1}
    \,
    \bvec{y_1}
    \right)
    \nonumber  \\
     & \approx
    \left(
    \bvec{D}\bvec{S_1}
    \,
    -
    \bvec{C}
    \right)
    \bvec{y_1}
    \,
    +
    \,
    \bvec{D} \, \bvec{s_0}
    \quad,
\end{align}
%
where $\circ$ denotes an elementwise product and $\bvec{C}$ is a matrix constructed by multiplying each row of $\bvec{B_1}$ by the corresponding element of $\bvec{D}\bvec{s_0}$.
%
This equation is now linear in $\bvec{y}_\bvec{1}$, so we may solve the least-squares problem as before:
%
\begin{align}
    \label{eq:norm:yhat}
    \bvec{\hat{y}_1} & =
    \boldsymbol{\Sigma}_\mathbf{\hat{y}_1}
    \left(
    \left(\bvec{D}\bvec{S_1} - \bvec{C}\right)^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    (\bvec{f} - \bvec{D}\bvec{s_0})
    +
    {\boldsymbol{\Lambda}_{\mathbf{y}_\bvec{1}}}^{-1} \boldsymbol{\mu}_{\mathbf{y}_\bvec{1}}
    \right)
    \quad,
\end{align}
%
with covariance
%
\begin{align}
    \label{eq:norm:ycov}
    \boldsymbol{\Sigma}_\mathbf{\hat{y}_1} & =
    \left(
    \left(\bvec{D}\bvec{S_1} - \bvec{C}\right)^\top
    {\boldsymbol{\Sigma}_\mathbf{f}}^{-1}
    \left(\bvec{D}\bvec{S_1} - \bvec{C}\right)
    +
    {\boldsymbol{\Lambda}_{\mathbf{y}_1}}^{-1}
    \right)^{-1}
    \quad.
\end{align}
%
Note, importantly, that these equations are valid only in the limit that the change in the total flux from the star is small. 
Nevertheless, even in the general case, we find that solving this linear problem yields a good starting point for a nonlinear optimization, which we revisit in more detail below.

\subsection{Limb darkening}
\label{sec:ld}
%
Thus far we have avoided mention of limb darkening, whose effect on the observed spectrum can often be significant. 
A proper treatment of limb darkening requires solution of radiative transfer equations and should account for the temperature and composition gradients in the stellar atmosphere. 
However, in the spirit of data-driven inference, we can approximate the effect of limb darkening by weighting the spatial component of our map by the limb darkening profile of the star, which can either be imposed or learned from the data. 
For a polynomial limb darkening law of the form
%
\begin{align}
    \label{eq:ld:I}
    \frac{I(\mu)}{I(\mu = 1)} = 1 - \sum_{n=1}^{n_\mathrm{max}} u_n(1 - \mu)^n
    \quad,
\end{align}
%
where $\mu = z = \sqrt{1 - x^2 - y^2}$ is the radial coordinate on the projected disk and $u_n$ is a limb darkening coefficient, the effect of limb darkening on the stellar map can be expressed exactly as a linear operation on the spherical harmonic coefficient vector \citep{Luger2019,Agol2019}. 
This can be understood by noting that all terms in Equation~(\ref{eq:ld:I}) are strictly polynomials in $x$, $y$, and $z$, all of which can be expressed exactly as sums of spherical harmonics \citep{Luger2019}. 
When weighting the surface intensity by the limb darkening profile, the resulting intensity is simply a product of spherical harmonics, which is itself a sum of spherical harmonics. 
Given a limb darkening law of degree $n_\mathrm{max}$, we can always construct a matrix $\bvec{L}$ that transforms a spherical harmonic vector $\bvec{y}$ of degree $l_\mathrm{max}$ to a limb-darkened spherical harmonic vector $\bvec{y'}$ of degree $l_\mathrm{max} + n_\mathrm{max}$. 
As an example, consider a map of degree $l_\mathrm{max} = 1$ and the linear limb darkening law ($n_\mathrm{max} = 1$).
The transformation matrix from $\bvec{y}$ to $\bvec{y'}$ is
%
\begin{align}
    \label{eq:ld:L}
    \bvec{L} =
    \frac{1}{1 - \frac{u_1}{3}}
    \begin{pmatrix}
        \quadquad1-u_1\quadquad & 0                       & \frac{u_1}{\sqrt{3}}    & 0                       \\
        0                       & \quadquad1-u_1\quadquad & 0                       & 0                       \\
        \frac{u_1}{\sqrt{3}}    & 0                       & \quadquad1-u_1\quadquad & 0                       \\
        0                       & 0                       & 0                       & \quadquad1-u_1\quadquad \\
        0                       & 0                       & 0                       & 0                       \\
        0                       & \frac{u_1}{\sqrt{5}}    & 0                       & 0                       \\
        0                       & 0                       & \frac{2u_1}{\sqrt{15}}  & 0                       \\
        0                       & 0                       & 0                       & \frac{u_1}{\sqrt{5}}    \\
        0                       & 0                       & 0                       & 0
    \end{pmatrix}
    \quad.
\end{align}
%
The columns of $\bvec{L}$ are constructed from the coefficient vectors of each transformed spherical harmonic, which are in turn computed by multiplying each spherical harmonic by the spherical harmonic decomposition of the particular limb darkening law.
Figure~\ref{fig:ld} shows this transformation with $u_1 = 1$ applied to each of the first four spherical harmonics.
%
\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=0.5\linewidth]{ld.pdf}
        \caption{%
            Illustration of the limb darkening transformation given by Equation~(\ref{eq:ld:L}) for a linear limb darkening law with $u_1 = 1$. 
            Each row shows a spherical harmonic before (left) and after (right) transformation by $\bvec{L}$.
        }
        \label{fig:ld}
    \end{centering}
\end{figure}
%

Now, to incorporate limb darkening into our model, we must modify how we compute the Doppler design matrix $\Doppler$ (Equation~\ref{eq:linear:D} and Figure~\ref{fig:linalg}). 
Recall that this matrix is constructed by vertically stacking the submatrices $\Doppler_m$ given by Equation~(\ref{eq:linear:Dm}), which we now compute as
%
\begin{align}
    \label{eq:ld:Dm}
    \Doppler_m =
    \begin{pmatrix}
        \quad
        \bvec{T}(\kT_0)
        \quad
         &
        \quad
        \bvec{T}(\kT_1)
        \quad
         &
        \quad
        \cdots
        \quad
         &
        \quad
        \bvec{T}(\kT_{N'})
        \quad
    \end{pmatrix}
    (\bvec{L} \, \bvec{R}(t_m) \otimes \bvec{I}_{K'})
    \quad,
\end{align}
%
where we have replaced the rotation matrix $\bvec{R}(t_m)$ with the linear transformation $\bvec{L}\,\bvec{R}(t_m)$, which first rotates the input spherical harmonic coefficient vector to the correct phase then limb darkens it. 
Note also that the terms in the convolution kernel $\kT$ are now indexed from 0 to $N' = (l_\mathrm{max} + n_\mathrm{max} + 1)^2$, where $n_\mathrm{max}$ is the degree of the limb darkening operator.

Note that it is also possible to model wavelength-dependent limb darkening in this fashion. 
The procedure is similar, except that the limb darkening coefficients $u_n$ are now functions of $\lnlam$, and each element of the matrix $\bvec{L}$ is now a vector of length $K'$. 
The submatrices $\Doppler_m$ may be written as
%
\begin{align}
    \label{eq:ld:Dmwav}
    \resizebox{0.91\textwidth}{!}{
        $
            \Doppler_m =
            \begin{pmatrix}
                \quad
                \bvec{T}(\kT_0)
                \quad
                 &
                \quad
                \bvec{T}(\kT_1)
                \quad
                 &
                \quad
                \cdots
                \quad
                 &
                \quad
                \bvec{T}(\kT_{N'})
                \quad
            \end{pmatrix}
            \begin{pmatrix}
                \mathrm{diag}(\bvec{L}_{0,0})
                 &
                \mathrm{diag}(\bvec{L}_{0,1})
                 &
                \cdots
                 &
                \mathrm{diag}(\bvec{L}_{0,N})
                \\
                \mathrm{diag}(\bvec{L}_{1,0})
                 &
                \mathrm{diag}(\bvec{L}_{1,1})
                 &
                \cdots
                 &
                \mathrm{diag}(\bvec{L}_{1,N})
                \\
                \cdots
                 &
                \cdots
                 &
                \ddots
                 &
                \cdots
                \\
                \mathrm{diag}(\bvec{L}_{N',0})
                 &
                \mathrm{diag}(\bvec{L}_{N',1})
                 &
                \cdots
                 &
                \mathrm{diag}(\bvec{L}_{N',N})
            \end{pmatrix}
            (\bvec{R}(t_m) \otimes \bvec{I}_{K'})
        $
    }
    \quad,
\end{align}
%
where $\mathrm{diag}(\bvec{v})$ denotes the $(K' \times K')$ diagonal matrix constructed by placing the vector $\bvec{v}$ along the main diagonal.

\subsection{Multiple spectral components}
\label{sec:eigen}
%
In our discussion so far we have focused on the particular case where the spectral/spatial decomposition of the stellar surface can be expressed as the outer product of two vectors (Equation~\ref{eq:inverse:azero}). 
As we mentioned previously, this corresponds to the case where the spectrum is constant across the surface of the star except for a spatially-variable amplitude: i.e., spots have the same spectrum as the rest of the star, but emit less flux overall. 
However, most of the formalism developed here also applies to the more general case where the spectrum at a particular point on the surface of the star is a linear combination of several different spectral components. 
In this case, the map vector $\azero$ may be written as the sum over $J$ spectra $\bvec{s}_j$, each of which is dotted into a different vector of spherical harmonic coefficients $\bvec{y}_j^\top$:
%
\begin{align}
    \label{eq:eigen:azero}
    \azero
     & =
    \sum_{j=0}^{J-1}\mathrm{vec}\left( \bvec{s}_j \, \bvec{y}_j^\top \right) \\
     & =
    \mathrm{vec}\left( \boldsymbol{\mathbb{S}} \, \boldsymbol{\mathbb{Y}}^\top \right) \quad,
\end{align}
%
where $\boldsymbol{\mathbb{S}}$ is the $(K' \times J)$ matrix whose columns are the $J$ spectral components and $\boldsymbol{\mathbb{Y}}^\top$ is the $(J \times N)$ matrix whose rows are the corresponding $J$ spherical harmonic coefficient vectors.

The model remains linear in both the spherical harmonic coefficients and the spectral components, and the procedures outlined in \S\ref{sec:inverse} may still be followed to solve the inverse problem, provided we unroll these matrices into vectors, letting $\mathbf{s} = \mathrm{vec}(\boldsymbol{\mathbb{S}})$ and $\mathbf{y} = \mathrm{vec}(\boldsymbol{\mathbb{Y}})$.
A detailed discussion of this general case is deferred to future work, but we present an example of a two-component stellar spectrum in \S\ref{sec:eigen}
below.

\section{Application to a spotted star}
\label{sec:spotstar}

In this section we apply the formalism developed in \S\ref{sec:inverse} and \S\ref{sec:bellswhistles} to a synthetic dataset of a rapidly rotating spotted star. 
This section is motivated by the examples in \cite{Vogt1987}, who generated rotationally-broadened spectra of a rapidly-rotating star with the letters ``VOGT'' painted across the northern hemisphere. 
In that paper, the authors generated synthetic line profiles of the Fe I $\lambda 6430$ absorption line with equivalent width $W \approx 10$~km/s and from these computed rotationally broadened spectra for a star at an inclination $i=40^\circ$ rotating at projected velocity $v\sin i = 40$~km/s.
The spectra were computed at 16 equally spaced rotational phases and downsampled to 32 wavelength bins per epoch, for a total of 512 data points.

\begin{figure}[t!]
    \begin{centering}
        \includegraphics[width=0.85\linewidth]{spot_setup.pdf}
        \caption{%
            The basic setup for the \spot problem. 
            We compute the $l_\mathrm{max} = 15$ spherical harmonic expansion of a map where the word ``SPOT'' has been placed across the northern hemisphere (top left). 
            Each point on the surface is given the same spectrum, composed of a sum of synthetic Gaussian absorption lines (blue curve in the bottom panel).
            The specific intensity at each point on the surface is equal to this spectrum weighted by the intensity of the map, which is close to zero within the spot (point labeled \texttt{B}) and close ot unity outside the spot (point labeled \texttt{A}).
            To generate the synthetic dataset (orange curves in the bottom panel), the star is inclined at $40^\circ$ with respect to the line of sight and the disk-integrated spectrum is computed at 16 equally-spaced phases between $-180^\circ$ and $180^\circ$ (middle panel).
            The grey regions indicate wavelength regions outside the observation window, but whose features still contribute to the observed spectrum due to rotational broadening.
        }
        \label{fig:spot_setup}
    \end{centering}
\end{figure}

We repeat the same experiment here using our new formalism, except we instead generate a stellar surface with the word ``SPOT'' written across the northern hemisphere (top left panel of Figure~\ref{fig:spot_setup}).
We do this by computing the $l_\mathrm{max} = 15$ spherical harmonic decomposition of an image of the word, generating a set of $N = (l_\mathrm{max} + 1)^2 = 256$ spherical harmonic coefficients $\bvec{y} = (1 \quadquad \bvec{y_1})$.

Our input spectrum $\bvec{s}$ was generated at high resolution ($R \equiv \frac{\lambda}{\Delta\lambda} = 300,000$) centered at a reference wavelength $\lambda_\mathrm{r} = 6430$ nm (blue curve in the bottom panel of Figure~\ref{fig:spot_setup}).
The spectrum consists of a Gaussian absorption line in log-wavelength ($\lnlam$) space with amplitude $0.5$ and standard deviation $\sigma_{\lnlam} = 1.4\times 10^{-5}$. 
This corresponds to a FWHM of about $2.355~\sigma_{\lnlam}~\lambda_\mathrm{r}~\approx~0.2$ nm or, in velocity space, $2.355~\sigma_{\lnlam}~c~\approx~10$~km/s, equal to the value used in \citet{Vogt1987}. 
Unlike \citet{Vogt1987}, we add 20 additional small absorption lines at random positions throughout the spectrum, all of the same FWHM but of varying depths, including some line blends. 
In total, the rest frame spectrum $\bvec{s}$ consists of $K = 201$ log-wavelength bins in the range $-\Delta\lnlam < \lnlam < \Delta\lnlam$ for $\Delta\lnlam = 3.3\times 10^{-4}$ plus an additional
%
\begin{align}
    W - 1 & = \frac{v\sin i}{c} \frac{K}{\Delta\lnlam} - 1 \nonumber           \\
          & = \left(\frac{40~\mathrm{km/s}}{3\times 10^5~\mathrm{km/s}}\right)
    \left(\frac{201}{3.3 \times 10^{-4}}\right)  - 1 \nonumber                 \\
          & = 80
\end{align}
%
log-wavelength bins of padding (40 on either side) to eliminate edge effects due to the convolution, for a total of $K' = 281$ wavelength bins. 
As in \citet{Vogt1987}, we assume a projected velocity of $v\sin i = 40$ km/s and an inclination $i = 40^\circ$.

Given $\bvec{y_1}$ and $\bvec{s}$, we use Equations~(\ref{eq:deconv:F}) and~%
(\ref{eq:inverse:azero}) to compute the data vector $\bvec{f}$ at $M = 16$ equally spaced rotational phases; these phases are shown in orthographic projection (as an observer would see the star) in the center panel of Figure~\ref{fig:spot_setup}. 
The synthetic spectra for each phase are shown as the orange curves in the bottom panel of the figure (note the different scaling, as all spectral lines become shallower due to the broadening). 
We assume a wavelength-independent, quadratic limb darkening law with $u_1 = 0.5$ and $u_2 = 0.25$. 
Finally, we divide the flux by the baseline at each epoch (Equation~\ref{eq:norm:b})
and add random Gaussian noise with amplitude $\sigma_\bvec{f} = 10^{-4}$ to simulate a very high signal-to-noise ratio (SNR) spectrum. 
The mean standard deviation in each wavelength bin across all 16 epochs in the noiseless data vector is about $10^{-2}$, so our choice of $\sigma_\bvec{f}$ corresponds to SNR $\sim$ 100 in each of the 201 wavelength bins of $\bvec{f}$.
%
%For reference, \citet{Vogt1987} report SNRs per 60 m\AA\, pixel, while our
%resolution elements are approximately $\lambda_r\Delta\lnlam/K \approx 100$ m\AA\,
%across, so our SNR in the same units as \citet{Vogt1987} is about 80.
%
% TODO: Perhaps Vogt computes the "signal" as the line depth, rather than
% as the amplitude of the perturbations? Check this.

% We Recover images with an effective resolution of $12^\circ$.

In the following sections we discuss various approaches to solving the Doppler imaging problem for this dataset.
Unless otherwise noted, in all experiments we adopt a Gaussian prior for the spherical harmonic coefficients $\bvec{y_1}$ with mean $\boldsymbol{\mu}_\bvec{y_1} = \bvec{0}$ and covariance $\boldsymbol{\Lambda}_\bvec{y_1} = (10^{-2})^2\bvec{I}$, corresponding to a flat power spectrum prior.
We place a Gaussian process prior on the spectrum $\bvec{s}$ with mean $\boldsymbol{\mu}_\bvec{s} = \bvec{1}$ and a covariance matrix $\boldsymbol{\Lambda}_\bvec{s}$ computed from a Mat\'ern-3/2 kernel with amplitude $\sigma_\bvec{s} = 0.3$ and lengthscale $\rho_\bvec{s} = 3\times 10^{-5}$.

\end{document}