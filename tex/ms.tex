\documentclass[modern]{aastex62}

% Load the corTeX style definitions
\input{cortex}

% Bibliography stuff
\bibliographystyle{aasjournal}

% Begin!
\begin{document}

% Title
\title{Doppler Imaging Fun}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{Megan Bedell}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{Probably David W. Hogg}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}

%
\section{Introduction}
%
Check out \citet{Luger2019} and \citet{Bedell2019} and stuff.

%
\section{The problem}
\label{sec:the_problem}
%
Let $I(\xi, x, y)$ be the Doppler-shifted intensity observed at log wavelength 
$\xi \equiv \ln\lambda$ at sky-projected Cartesian position $x, y$ on the 
surface of the star. We may express it as
%
\begin{align}
    \label{eq:I}
    I(\xi, x, y) &= I_0(\xi_0, x, y)
\end{align}
%
where $I_0$ is the spectrum at each point on the star in the surface rest
frame and 
%
\begin{align}
    \label{eq:xi0}
    \xi_0 &= \xi + \alpha(x, y)
\end{align}
%
is the log wavelength in the unshifted frame. The quantity $\alpha$ is
computed from the formula for the Doppler shift and is equal to
%
\begin{align}
    \label{eq:alpha}
    \alpha(x, y) 
        &=
        \frac{1}{2}\ln\left( 
            \frac{1 - \beta}{1 + \beta} 
        \right) 
        \nonumber \\
        &\approx
        \ln(1 - \beta)
\end{align}
%
where $\beta = v(x, y) / c$ is the ratio of the 
radial velocity at a point on the surface of the star to the speed of light
and the second line is valid when $\beta \ll 1$ (i.e., the non-relativistic
Doppler shift). Throughout this paper, we will assume the non-relativistic 
limit, as it greatly simplifies the math.
In keeping with the literature, we take positive values of $v$ to mean 
redshifts.

A common approach to computing the Doppler-shifted spectrum is to
evaluate the spectrum at the rest frame wavelength (Equation~\ref{eq:xi0})
and interpolate back to the grid in $\xi$. This is practical when
computing the spectrum at a single \emph{point} on the surface, but not
ideal when one is interested in the \emph{integral} over the entire
surface of the star $\mathcal{S}$, which is typically all we can observe:
%
\begin{align}
    \label{eq:S}
    S(\xi) 
        &\equiv
        \iint\limits_{\mathcal{S}(x, y)}
                I(\xi, x, y)
        \mathrm{d}{\mathcal{S}(x, y)}
        \quad .
\end{align}
%
The difficulty in solving Equation~(\ref{eq:S}) stems from the fact
that $I(\xi, x, y)$ is difficult to write down in closed form, given
the non-linearity of the Doppler shift.
The standard approach to solving this integral is therefore
to discretize the surface of the star with a fine grid, evaluate the
Doppler-shifted spectrum in each cell, and sum over the spatial axes
to approximate the integral. Depending on the resolution of the grid,
this is either numerically inaccurate or computationally inefficient 
(and often both).

\section{The Solution}

In this section, we consider two alternative methods to solving
Equation~(\ref{eq:S}) to improve the speed and accuracy of the
computation, both of which rely on the Fourier transform of the
spectrum.
Recall the definition of the Fourier transform of a function $f(\xi)$,
%
\begin{align}
    \label{eq:fourier:FT}
    \mathcal{F}\Big[f(\xi)\Big](k) 
    &\equiv
    \int_{-\infty}^\infty
        f(\xi)
        \mathrm{e}^{-2\pi \imag k \xi} \mathrm{d}\xi
    \nonumber \\
    &=
    \hat{f}(k)
    \quad ,
\end{align}
%
and the corresponding inverse Fourier transform,
%
\begin{align}
    \label{eq:fourier:IFT}
    \mathcal{F}^{-1}\Big[\hat{f}(k)\Big](\xi) 
    &\equiv
    \int_{-\infty}^\infty
        \hat{f}(k)
        \mathrm{e}^{2\pi \imag k \xi} \mathrm{d}k
    \nonumber \\
    &=
    f(\xi)
    \quad .
\end{align}
%
Consider what happens when we take the
Fourier transform of the spectrum $I(\xi, x, y)$ to obtain
a function $\hat{I}(k, x, y)$, where we refer to $k$ as a ``wavenumber''. 
A useful property of the
Fourier transform is that a translation of $I(\xi, x, y)$ by
an amount $\Delta\xi$ corresponds to a linear scaling
of $\hat{I}(k, x, y)$ by an amount $\mathrm{e}^{-2\pi \imag k \Delta\xi}$
\citep[e.g.,][]{Schoenstadt2006}.
Specifically, if the Doppler-shifted spectrum is given by
%
\begin{align}
    I(\xi, x, y) &= I_0\big(\xi + \alpha(x, y)\big), x, y) \quad,
\end{align}
%
its Fourier transform is equal to 
%
\begin{align}
    \label{eq:fourier:translation}
    \hat{I}(\xi, x, y) 
    &= 
    \mathrm{e}^{2\pi \imag k \alpha(x, y)}\hat{I_0}(k, x, y)
    \quad ,
\end{align}
%
where $\hat{I_0}(k, x, y) \equiv \mathcal{F}\left[ I_0(\xi, x, y) \right]$.
%
To obtain the Fourier transform of the observed spectrum, we first
expand $\hat{I_0}(k, x, y)$ in terms of spherical harmonics,
%
\begin{align}
    \label{eq:fourier:I0}
    \hat{I_0}(k, x, y) 
        &=
        \sum_{l=0}^\infty\sum_{m=-l}^{l} Y_{lm}(x, y) \hat{a}_{lm}(k)
    \nonumber \\
    &= 
    \tilde{\bvec{y}}^\top(x, y) \cdot \bvec{\hat{a}}(k)
    \quad ,
\end{align}
%
where
%
\begin{align}
    \bvec{\hat{a}}(k) \equiv
\Big( 
    \hat{a}_{0,0}(k) \quad\quad\quad\quad\quad\quad 
    \hat{a}_{1,-1}(k) \quad\quad\quad\quad\quad\quad 
    \hat{a}_{1,0}(k) \quad\quad\quad\quad\quad\quad
    \hat{a}_{1,1}(k) \quad\quad\quad\quad\quad\quad 
    ... 
\Big)^\top
\end{align}
%
is the column vector of spherical harmonic coefficients at wavenumber $k$, and
%
\begin{align}
    \tilde{\bvec{y}}^\top(x, y) \equiv 
\Big( 
    Y_{0,0}(x, y) \quad\quad\quad\quad\quad\quad 
    Y_{1,-1}(x, y) \quad\quad\quad\quad\quad\quad 
    Y_{1,0}(x, y) \quad\quad\quad\quad\quad\quad 
    Y_{1,1}(x, y) \quad\quad\quad\quad\quad\quad 
    ... 
\Big)
\end{align}
%
is the corresponding row vector of spherical harmonics at a point $(x, y)$ 
on the sphere.
%
We then take the integral of Equation~(\ref{eq:fourier:translation})
over the visible disk $\mathcal{S}$ of the star:
%
\begin{align}
    \label{eq:fourier:SYlm}
    \hat{S}(k) 
    &=
        \iint\limits_{\mathcal{S}(x, y)}
        \tilde{\bvec{y}}^\top(x, y)
        \mathrm{e}^{2\pi \imag k \alpha(x, y)}
        \mathrm{d}\mathcal{S}(x, y)
        \cdot
        \bvec{\hat{a}}(k)
    \quad ,
\end{align}
%
In order to tackle the integrals in 
Equation~(\ref{eq:fourier:SYlm}), let us change bases from spherical
harmonics to polynomials on the sphere:
%
\begin{align}
    \label{eq:fourier:S}
    \hat{S}(k) 
    &=
        \iint\limits_{\mathcal{S}(x, y)}
        \tilde{\bvec{p}}^\top(x, y)
        \mathrm{e}^{2\pi \imag k \alpha(x, y)}
        \mathrm{d}\mathcal{S}(x, y)
        \cdot
        \bvec{A_1}
        \cdot
        \bvec{\hat{a}}(k)
    \quad .
\end{align}
%
where
%
\begin{align}
    \tilde{\bvec{p}}^\top(x, y) \equiv 
\Big( 
    1 \quad\quad\quad\quad\quad\quad 
    x \quad\quad\quad\quad\quad\quad 
    z \quad\quad\quad\quad\quad\quad 
    y \quad\quad\quad\quad\quad\quad 
    x^2 \quad\quad\quad\quad\quad\quad 
    xz \quad\quad\quad\quad\quad\quad 
    xy \quad\quad\quad\quad\quad\quad
    yz \quad\quad\quad\quad\quad\quad 
    y^2 \quad\quad\quad\quad\quad\quad
    ... 
\Big)
\end{align}
%
is the polynomial basis \citep[Equation 7 in][]{Luger2019}
and $\bvec{A_1}$ is the change of basis matrix from spherical harmonics
to polynomials 
\citep[Equation B11 in][]{Luger2019}. On the observer-facing surface of 
the unit sphere, the coordinate $z$ is given by $\sqrt{1 - x^2 - y^2}$.

At this point, we have two options: we can remain in Fourier space and
attempt to solve the surface integral in Equation~(\ref{eq:fourier:S})
directly, or we can take the inverse Fourier transform of  
Equation~(\ref{eq:fourier:S}) and attempt to solve the integral in
log wavelength space. As we will see, there are advantages (and
disadvantages) to both methods. We do the former in \S\ref{sec:analytic}
in the latter in \S\ref{sec:convolve}.

\subsection{Analytic solutions}
\label{sec:analytic}
In the case that the integration area $\mathcal{S}$ is the entire surface of
the star, the integrals in Equation~(\ref{eq:fourier:S}) are
\emph{analytic}. \xxx{Show here how the result can be computed from the 
hypergeometric function $_3F_2.$}

\subsection{Doppler shifts as a convolution}
\label{sec:convolve}

If we take the inverse Fourier transform of Equation~(\ref{eq:fourier:S}),
we arrive at an expression for the observed spectrum:
%
\begin{align}
    \label{eq:convolve:SUgly1}
    S(\xi) 
    &=
    \mathcal{F}^{-1} \Bigg[\,\,\,
        \iint\limits_{\mathcal{S}(x, y)}
        \tilde{\bvec{p}}^\top(x, y)
        \mathrm{e}^{2\pi \imag k \alpha(x, y)}
        \mathrm{d}\mathcal{S}(x, y)
        \cdot
        \bvec{A_1}
        \cdot
        \bvec{\hat{a}}(k)
    \Bigg] \nonumber \\
    &=
    \mathcal{F}^{-1} \Bigg[\,\,\,
        \iint\limits_{\mathcal{S}(x, y)}
        \tilde{\bvec{p}}^\top(x, y)
        \mathrm{e}^{2\pi \imag k \alpha(x, y)}
        \mathrm{d}\mathcal{S}(x, y)
        \cdot
        \bvec{A_1}
    \Bigg]
    *
    \bvec{a}(\xi)
    \quad ,
\end{align}
%
where the second line follows from the convolution theorem, with
$\bvec{a}(\xi) \equiv \mathcal{F}^{-1}\left[ \bvec{\hat{a}}(k) \right]$
and $*$ denoting the convolution operator over $\xi$:
%
\begin{align}
    (f * g)(\xi) \equiv \int\limits_{-\infty}^{\infty}f(\tau)g(\xi - \tau)\mathrm{d}\tau
\end{align}
%
Since only the exponential term in the integrand depends on $k$, we may 
further simplify this expression:
%
\begin{align}
    \label{eq:convolve:SUgly2}
    S(\xi) 
    &=    
    \iint\limits_{\mathcal{S}(x, y)}
    \tilde{\bvec{p}}^\top(x, y)
    \mathcal{F}^{-1} \Big[
        \mathrm{e}^{2\pi \imag k \alpha(x, y)}
    \Big]
    \mathrm{d}\mathcal{S}(x, y)
    \cdot
    \bvec{A_1}
    *
    \bvec{a}(\xi)
    \nonumber \\
    &=    
    \iint\limits_{\mathcal{S}(x, y)}
    \tilde{\bvec{p}}^\top(x, y)
    \delta\big(\xi - \alpha(x, y)\big)
    \mathrm{d}\mathcal{S}(x, y)
    \cdot
    \bvec{A_1}
    *
    \bvec{a}(\xi)
    \quad,
\end{align}
%
where $\delta$ is the Dirac delta function. Since the integrand in the
equation above is zero everywhere except where the argument of the
$\delta$ function is zero, the equation may be written as a line integral 
along some curve $\mathcal{C}(x, y)$ whose points satisfy 
$\alpha(x, y) = \xi$
and lie within $\mathcal{S}$:
%
\begin{align}
    \label{eq:convolve:S}
    S(\xi) 
    &=    
    \mathbf{g}(\xi)
    *
    \bvec{a}(\xi)
    \quad,
\end{align}
%
where we define
%
\begin{align}
    \label{eq:convolve:g}
    \mathbf{g}(\xi) 
    &\equiv    
    \mathbf{s}^\top(\xi) 
    \cdot
    \bvec{A_1}
\end{align}
%
and
%
\begin{align}
    \label{eq:convolve:sT}
    \mathbf{s}^\top(\xi) 
    &\equiv    
    \int\limits_{\mathcal{C}(x, y)}
    \tilde{\bvec{p}}^\top(x, y)
    \mathrm{d}\mathcal{C}(x, y)
    \quad.
\end{align}

In order to solve Equation~(\ref{eq:convolve:S}), we must assume 
explicit functional
forms for the velocity field $\alpha(x, y)$ and the region of integration
$\mathcal{S}$, which we do in the following sections.

\section{Doppler imaging of rigid rotators}
\label{sec:rigid}
%
In the case that the star's rotation is rigid (i.e., differential rotation
is negligible), the radial velocity at any point on the surface is 
simply proportional to the distance to the axis of rotation. Without loss
of generality, if we assume the axis of rotation lies along the $y-z$ plane,
we have
%
\begin{align}
    \beta(x, y) = \frac{\omega \sin i \, x}{c}
\end{align}
%
and
%
\begin{align}
    \label{eq:rigid:alpha}
    \alpha(x, y) = \ln\left( 1 - \frac{\omega \sin i \, x}{c} \right)
    \quad ,
\end{align}
%
where $\omega$ is the angular velocity of the star and $i$ is the
inclination relative to $\hat{y}$. Furthermore, if
we assume the star is unocculted, the region of integration $\mathcal{S}$ 
is simply the unit disk, so $\mathcal{C}(x, y)$ is the set of all points
that satisfy both $\alpha(x, y) = \xi$ and $x^2 + y^2 \le 1$.
Solving Equation~(\ref{eq:rigid:alpha}) for $x$ and 
setting $\alpha(x, y) = \xi$, we find that the curves $\mathcal{C}(x, y)$ 
are simply vertical lines on the unit disk given by
%
\begin{align}
    x &= 
        \frac{c}{\omega\sin i} \left(1 - \mathrm{e}^{\xi}\right)
    \nonumber \\
    &\equiv \gamma(\xi)
    \quad .
\end{align}
%
The integral in Equation~(\ref{eq:convolve:sT}) is therefore just an integral
over $y$:
%
\begin{align}
    \label{eq:rigid:sT}
    \bvec{s}^\top(\xi) 
    &=    
    \int\limits_{-\sqrt{1 - \gamma(\xi)^2}}^{\sqrt{1 - \gamma(\xi)^2}}
    \tilde{\bvec{p}}^\top
    \Big(\gamma(\xi), y\Big)
    \mathrm{d}y
    \quad .
\end{align}
%
From \citet{Luger2019}, the $n^\mathrm{th}$ term of the polynomial basis
is a polynomial in $x$, $y$, and $z = \sqrt{1 - x^2 - y^2}$:
%
\begin{proof}{PolynomialBasis}
    \tilde{p}_n 
    &=
    x^i y^j z^k
\end{proof}
%
where $i, j, k$ are integers given by
%
\begin{proof}{PolynomialBasis}
    \label{eq:lm}
    i &= \floor*{\Lambda - \Delta}
    \nonumber \\[0.5em]
    j &= \floor*{\Delta}
    \nonumber \\[0.5em]
    k &= \ceil*{\Delta} - \floor*{\Delta}
\end{proof}
%
with
%
\begin{proof}{PolynomialBasis}
    \Lambda &= \floor*{\sqrt{n}}
    \nonumber \\[0.5em]
    \Delta &= \frac{n - \Lambda^2}{2}
    \quad .
\end{proof}
%
We may now explicitly write down the $n^\mathrm{th}$ term of 
Equation~(\ref{eq:rigid:sT}),
%
\begin{align}
    s_n(\xi) 
    &=    
    \begin{dcases}
        \gamma(\xi)^i
        \int\limits_{-\sqrt{1 - \gamma(\xi)^2}}^{\sqrt{1 - \gamma(\xi)^2}}
            y^j
        \mathrm{d}y
        &
        \qquad k = 0
        \\[1em]
        \gamma(\xi)^i
        \int\limits_{-\sqrt{1 - \gamma(\xi)^2}}^{\sqrt{1 - \gamma(\xi)^2}}
            y^j
            \sqrt{1 - \gamma(\xi)^2 - y^2} \,
        \mathrm{d}y 
        & 
        \qquad k = 1 \quad ,
    \end{dcases}
\end{align}
%
and solve it analytically:
%
\begin{align}
        \label{eq:rigid:sTAnalytic}
        s_n(\xi) 
        &=     
    \begin{dcases}
        \frac{2 \gamma(\xi)^i \big(1 - \gamma(\xi)^ 2\big)^{\frac{j + 1}{2}}}{j + 1}
        &
        \qquad k = 0 \,\,\, \& \,\,\, j \, \mathrm{even}
        \\[1em]
        \gamma(\xi)^{i} \mathcal{I}_{j}\big(\gamma(\xi)\big)
        &
        \qquad k = 1 \,\,\, \& \,\,\, j \, \mathrm{even}
        \\[1em]
        0
        &
        \qquad j \, \mathrm{odd} \quad,
    \end{dcases}
\end{align}
%
where $\mathcal{I}_j(\gamma)$ is computed analytically
from the upward recurrence relation given by Equation~(\ref{eq:app:Ij}),
with $\mathcal{I}_0(\gamma)$ given by Equation~(\ref{eq:app:I0}).

\appendix

\section{Integrals}
\subsection{Equation~(\ref{eq:rigid:sTAnalytic})}
%
When $k = 1$, we may write the $n^\mathrm{th}$ component
of Equation~(\ref{eq:rigid:sTAnalytic}) as
%
\begin{align}
    s_n(\xi) = 
        \gamma(\xi)^{i}
        \mathcal{I}_{j}\big(\gamma(\xi)\big)
\end{align}
%
where
%
\begin{align}
    \mathcal{I}_j(\gamma) &\equiv
    \int\limits_{-\sqrt{1-\gamma^2}}^{\sqrt{1-\gamma^2}}
        y^{j}
        \sqrt{1 - \gamma^2 - y^2} \,
    \mathrm{d}y
    \quad.
\end{align}
%
Substituting $y = \sin\psi\sqrt{1 - \gamma^2}$, we have
%
\begin{align}
    \mathcal{I}_j(\gamma) &=
    %
    (1 - \gamma^2)^{\frac{j + 2}{2}}
    \int\limits_{-\frac{\pi}{2}}^{\frac{\pi}{2}}
        \sin^j\psi
        \cos^2\psi \,
    \mathrm{d}\psi
    \quad.
\end{align}
%
We may solve this integral using the recurrence relation
%
\begin{align}
    \int
        \sin^j\psi
        \cos^m\psi \,
    \mathrm{d}\psi
    &=
    -\frac{\sin^{j-1}\psi \cos^{m+1}\psi}{j + m}
    +
    \frac{j - 1}{j + m}\int\sin^{j-2}\psi \cos^m\psi \mathrm{d}\psi
    \quad ,
\end{align}
%
which, in our case, simplifies to
%
\begin{align}
    \int\limits_{-\frac{\pi}{2}}^{\frac{\pi}{2}}
        \sin^j\psi
        \cos^2\psi \,
    \mathrm{d}\psi
    &=
    \frac{j - 1}{j + 2}\int\limits_{-\frac{\pi}{2}}^{\frac{\pi}{2}}\sin^{j-2}\psi \cos^2\psi \mathrm{d}\psi
    \quad.
\end{align}
%
We thus arrive at the recurrence relation
%
\begin{align}
    \label{eq:app:Ij}
    \mathcal{I}_j(\gamma) &=
    \frac{j - 1}{j + 2}
    (1 - \gamma^2)
    \mathcal{I}_{j-2}(\gamma)
    \quad.
\end{align}
%
Since this expression is only used when $j$ is even, we only need one
initial condition for upward recursion:
%
\begin{align}
    \label{eq:app:I0}
    \mathcal{I}_0(\gamma) &\equiv
    \int\limits_{-\sqrt{1-\gamma^2}}^{\sqrt{1-\gamma^2}}
        \sqrt{1 - \gamma^2 - y^2} \,
    \mathrm{d}y
    \nonumber \\
    &= \frac{\pi}{2}(1 - \gamma^2)
    \quad.
\end{align}

% Bibliography
\bibliography{bib}

\end{document}
