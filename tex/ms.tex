\documentclass[modern]{aastex62}

% Load the corTeX style definitions
\input{cortex}

% Bibliography stuff
\bibliographystyle{aasjournal}

% Begin!
\begin{document}

% Title
\title{Doppler Imaging Fun}

% Author list
\author[0000-0002-0296-3826]{Rodrigo Luger}
\email{rluger@flatironinstitute.org}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{Megan Bedell}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}
%
\author{David W. Hogg}
\affil{Center~for~Computational~Astrophysics, Flatiron~Institute, New~York, NY}

%
\section{Introduction}
%
Check out \citet{Luger2019} and \citet{Bedell2019} and stuff.

%
\section{The problem}
\label{sec:the_problem}
%
Let $I(\xi, \mathbf{x}, t, \mathbf{d})$ be the specific 
intensity observed 
at log wavelength $\xi \equiv \ln\lambda$ and at sky-projected 
Cartesian position $\mathbf{x} = (x, y, z)$ on the surface of the 
star at time $t$, where
$\mathbf{d}$ is a set of arbitrary parameters of the Doppler field.
We may express this intensity as
%
\begin{align}
    \label{eq:intro:Ixi}
    I(\xi, \mathbf{x}, t, \mathbf{d}) &= 
        I_0\Big(\xi_0(\xi, \mathbf{x}, \mathbf{d}), \mathbf{x}, t\Big)
\end{align}
%
where $I_0$ is the specific intensity at each point on the star 
in the surface rest frame and 
%
\begin{align}
    \label{eq:intro:xi0}
    \xi_0(\xi, \mathbf{x}, \mathbf{d}) &= 
    \xi - \mathcal{D}(\mathbf{x}, \mathbf{d})
\end{align}
%
is the log wavelength in the rest frame. The quantity $\mathcal{D}$ is
the Doppler shift in log wavelength space:
%
\begin{align}
    \label{eq:intro:D}
    \mathcal{D}(\mathbf{x}, \mathbf{d}) 
        &=
        \frac{1}{2}\ln\left( 
            \frac{1 + \beta(\mathbf{x}, \mathbf{d})}{1 - \beta(\mathbf{x}, 
            \mathbf{d})} 
        \right)
\end{align}
%
where $\beta = v(\mathbf{x}, \mathbf{d}) / c$ is the ratio of the 
radial velocity at a point on the surface of the star to the speed of light.
In keeping with the literature, we take positive values of $v$ (and
$\mathcal{D}$) to mean redshifts.

A common approach to computing the Doppler-shifted spectrum is to
evaluate the spectrum at the rest frame wavelength 
(Equation~\ref{eq:intro:xi0})
and interpolate back to the grid in $\xi$. This is practical when
computing the spectrum at a single \emph{point} on the surface, but not
ideal when one is interested in the \emph{integral} over the visible
surface of the star $\mathcal{S}$, which is typically all we can observe:
%
\begin{align}
    \label{eq:intro:Fxi}
    F(\xi, t) 
        &\equiv
        \iint\limits_{\mathcal{S}(\mathbf{x})}
                I(\xi, \mathbf{x}, t, \mathbf{d})
        \mathrm{d}{\mathcal{S}(\mathbf{x})}
        \quad ,
\end{align}
%
The difficulty in solving Equation~(\ref{eq:intro:Fxi}) stems from the fact
that $I(\xi, \mathbf{x}, t, \mathbf{d})$ is difficult to write down in 
closed form, given
the non-linearity of the Doppler shift.
The standard approach to solving this integral is therefore
to discretize the surface of the star with a fine grid, evaluate the
Doppler-shifted spectrum in each cell, and sum over the spatial axes
to approximate the integral. Depending on the resolution of the grid,
this is either numerically inaccurate or computationally inefficient 
(and often both).


\section{The Solution}

The observed spectrum is a complex function
of spatial, spectral, temporal, and velocity terms. The goal in this
section is to deconvolve each of these terms to make solving the integral
in Equation~(\ref{eq:intro:Fxi}) easier.
%
The first thing we will do is to expand the spatial dependence of the
specific intensity in terms of spherical harmonics on the unit disk:
%
\begin{align}
    \label{eq:solution:Ixi0}
    I_0(\xi_0, \mathbf{x}, t) 
        &=
        \sum_{l=0}^\infty\sum_{m=-l}^{l} a_{lm}(\xi_0, t) Y_{lm}(\mathbf{x})
    \quad ,
\end{align}
%
where $Y_{lm}(\mathbf{x})$ is a spherical harmonic on the projected disk
and $a_{lm}(\xi_0, t)$ is the corresponding spherical harmonic 
coefficient at log wavelength in the rest frame $\xi_0$ and time $t$. For 
convenience, we may write this equation in vector form:
%
\begin{align}
    \label{eq:solution:Ixi0vec}
    I_0(\xi_0, \mathbf{x}, t) &=
    \tilde{\bvec{y}}^\top(\mathbf{x})
    \bvec{a}(\xi_0, t)
    \quad ,
\end{align}
%
where
%
\begin{align}
    \bvec{a}(\xi_0, t) \equiv
\Big( 
    a_{0,0}(\xi_0, t) \quad\quad\quad\quad\quad\quad 
    a_{1,-1}(\xi_0, t) \quad\quad\quad\quad\quad\quad 
    a_{1,0}(\xi_0, t) \quad\quad\quad\quad\quad\quad
    a_{1,1}(\xi_0, t) \quad\quad\quad\quad\quad\quad 
    ... 
\Big)^\top
\end{align}
%
is the vector of spherical harmonic coefficients and
%
\begin{align}
    \tilde{\bvec{y}}^\top(\mathbf{x}) \equiv 
\Big( 
    Y_{0,0}(\mathbf{x}) \quad\quad\quad\quad\quad\quad 
    Y_{1,-1}(\mathbf{x}) \quad\quad\quad\quad\quad\quad 
    Y_{1,0}(\mathbf{x}) \quad\quad\quad\quad\quad\quad 
    Y_{1,1}(\mathbf{x}) \quad\quad\quad\quad\quad\quad 
    ... 
\Big)
\end{align}
%
is the corresponding vector of spherical harmonics. We may further
decompose our expression by linearizing the time dependence of the
spherical harmonic coefficients:
%
\begin{align}
    \label{eq:solution:R}
    \bvec{a}(\xi_0, t) = \mathbf{R}(t) \bvec{a}(\xi_0)
    \quad ,
\end{align}
%
where $\bvec{a}(\xi_0) = \bvec{a}(\xi_0, t=t_0)$ for some reference time $t_0$.
For rigid body rotation, the result is exact and $\mathbf{R}(t)$ is the Wigner 
rotation matrix for real spherical harmonics 
\citep[e.g.][]{AlvarezCollado1989}, which is implicitly a 
function of the inclination, obliquity, and rotation period of the star.
In the case that other processes such as differential rotation or spot 
evolution are significant
over the course of an observation, Equation~(\ref{eq:solution:R}) can be
made to hold approximately for some effective rotation matrix 
$\mathbf{R}(t)$; we discuss this further below.

The equation for the specific intensity now reads
%
\begin{align}
    \label{eq:solution:Ixi0vecfull}
    I_0(\xi_0, \mathbf{x}, t) &=
    \tilde{\bvec{y}}^\top(\mathbf{x})
    \mathbf{R}(t)
    \bvec{a}(\xi_0)
    \quad ,
\end{align}
%
where it is clear that we have fully separated the spatial, temporal, and
spectral terms. However, in order to compute the observed spectrum, we must
still Doppler shift this expression and integrate it over the visible
portion of the star. To this end, it is convenient to express the Doppler
shift as a convolution
of the spectrum in the rest frame with a delta function:
%
\begin{align}
    I(\xi, \mathbf{x}, t) &= 
        I_0(\xi_0, \mathbf{x}, t) 
        * \delta\big(\mathcal{D}(\mathbf{x}, \mathbf{d}) - (\xi - \xi_0)\big)
        \quad,
\end{align}
%
where $*$ denotes the convolution operation, 
returning a function of the shifted log wavelength, $\xi$.
Inserting this into Equation~(\ref{eq:solution:Ixi0vecfull}) and integrating
over the visible portion of the star, we arrive at the expression for the 
observed spectrum:
%
%
\begin{align}
    \label{eq:solution:Fxi}
    F(\xi, t) &=
    \iint\limits_{\mathcal{S}(\mathbf{x})}
    \tilde{\bvec{y}}^\top(\mathbf{x})
    \mathbf{R}(t)
    \bvec{a}(\xi_0)
    * \delta\big(\mathcal{D}(\mathbf{x}, \mathbf{d}) - (\xi - \xi_0)\big)
    \mathrm{d}\mathcal{S}(\mathbf{x})
    \nonumber \\[0.5em]
    &=
    \mathbf{g}^\top(\mathcal{D})
    *
    \,
    \mathbf{R}(t)
    \,
    \bvec{a}(\xi_0)
    \quad ,
\end{align}
%
%
where we made use of the commutativity of the convolution operator and 
the fact that the integral is taken only over the spatial dimensions.
We further define
%
\begin{align}
    \label{eq:solution:gT}
    \mathbf{g}^\top(\mathcal{D})
    &\equiv
    \iint\limits_{\mathcal{S}(\mathbf{x})}
    \tilde{\bvec{y}}^\top(\mathbf{x})
    \delta\big(\mathcal{D}(\mathbf{x}, \mathbf{d}) - (\xi - \xi_0)\big)
    \mathrm{d}\mathcal{S}(\mathbf{x})
    \nonumber \\[0.5em]
    &=  
    \int\limits_{\mathcal{C}(\mathbf{x}, \mathbf{d})}
    \tilde{\bvec{y}}^\top(\mathbf{x})
    \mathrm{d}\mathcal{C}(\mathbf{x}, \mathbf{d})
    \quad.
\end{align}
%
where the integral in the second line denotes the line integral about
some function $\mathcal{C}(\mathbf{x}, \mathbf{d})$ corresponding to the
set of all points on the visible disk where 
$\mathcal{D}(\mathbf{x}, \mathbf{d}) = \xi - \xi_0$.

Equation~(\ref{eq:solution:Fxi}) is the complete deconvolution of the
observed spectrum into velocity terms, temporal terms, and spectral/spatial
terms, respectively. In the following sections, we will discuss how to
efficiently solve Equation~(\ref{eq:solution:gT}).

\section{Doppler imaging of rigid rotators}
\label{sec:rigid}
%
In the case that the star's rotation is rigid (i.e., differential rotation
is negligible) and other effects such as convective blueshift
may be ignored, the radial velocity at any point on the surface is 
simply proportional to the distance to the axis of rotation. Without loss
of generality, if we assume the axis of rotation lies along the $y-z$ plane,
we have
%
\begin{align}
    \beta(\mathbf{x}, \mathbf{d}) = \frac{\omega \sin i \, x}{c}
\end{align}
%
and
%
\begin{align}
    \label{eq:rigid:D}
    \mathcal{D}(\mathbf{x}, \mathbf{d}) &= 
        \frac{1}{2}\ln\left( 
            \dfrac{1 + \dfrac{\omega \sin i \, x}{c}}
                 {1 - \dfrac{\omega \sin i \, x}{c}}
        \right)
    \quad ,
\end{align}
%
where the parameters $\mathbf{d}$ of the Doppler field are the
angular velocity, $\omega$, and the inclination of the star with
respect to $\hat{y}$, $i$. 

In order to solve Equation~(\ref{eq:solution:gT}), let us change basis from
spherical harmonics to polynomials on the sphere:
%
\begin{align}
    \label{eq:rigid:gT}
    \mathbf{g}^\top(\mathcal{D}) &\equiv
    \bvec{s}^\top(\mathcal{D})
    \bvec{A_1}
\end{align}
%
where
%
\begin{align}
    \label{eq:rigid:sTdef}
    \mathbf{s}^\top(\mathcal{D})
    &\equiv
    \int\limits_{\mathcal{C}(\mathbf{x}, \mathbf{d})}
    \tilde{\bvec{p}}^\top(\mathbf{x})
    \mathrm{d}\mathcal{C}(\mathbf{x}, \mathbf{d})
\end{align}
%
is the vector of integral solutions for each spherical harmonic,
%
\begin{align}
    \tilde{\bvec{p}}(\mathbf{x}) \equiv 
\Big( 
    1 \quad\quad\quad\quad\quad\quad 
    x \quad\quad\quad\quad\quad\quad 
    z \quad\quad\quad\quad\quad\quad 
    y \quad\quad\quad\quad\quad\quad 
    x^2 \quad\quad\quad\quad\quad\quad 
    xz \quad\quad\quad\quad\quad\quad 
    xy \quad\quad\quad\quad\quad\quad
    yz \quad\quad\quad\quad\quad\quad 
    y^2 \quad\quad\quad\quad\quad\quad
    ... 
\Big)^\top
\end{align}
%
is the polynomial basis \citep[Equation 7 in][]{Luger2019},
and $\bvec{A_1}$ is the change of basis matrix from spherical harmonics
to polynomials 
\citep[Equation B11 in][]{Luger2019}. On the observer-facing surface of 
the unit sphere, the coordinate $z$ is given by $\sqrt{1 - x^2 - y^2}$.

\begin{figure}[h!]
    \begin{centering}
    \includegraphics[width=\linewidth]{figures/g.pdf}
    \oscaption{g}{%
        The Doppler $\mathbf{g}$ basis for a rigidly rotating star
        computed from Equation~(\ref{eq:rigid:gT}) and
        Equation~(\ref{eq:rigid:sTAnalytic}) up to spherical 
        harmonic degree $l=10$. Rows correspond to the degree $l$ and
        columns correspond to the order $m$. These functions encode
        the contribution of each spherical harmonic to the rotational
        broadening of features in the stellar spectrum. Because the
        rotational axis is chosen to be aligned with $\hat{y}$,
        none of the $m < 0$ harmonics contribute to the observed
        spectrum.
        \label{fig:g}
    }
    \end{centering}
\end{figure}

If we assume the star is unocculted, the region of integration $\mathcal{S}$ 
is simply the unit disk, so $\mathcal{C}(\mathbf{x}, \mathbf{d})$ 
is the set of all points
that satisfy both $\mathcal{D}(\mathbf{x}, \mathbf{d}) = \xi - \xi_0$ and 
$x^2 + y^2 \le 1$.
Solving Equation~(\ref{eq:rigid:D}) for $x$, we find that 
the curves $\mathcal{C}(\mathbf{x}, \mathbf{d})$ 
are simply vertical lines on the unit disk given by
%
\begin{align}
    x(\mathcal{D}) &= 
        \Bigg(\frac{c}{\omega\sin i}\Bigg) 
        \Bigg(\frac{\mathrm{e}^{2\mathcal{D}} - 1}
                   {\mathrm{e}^{2\mathcal{D}} + 1}\Bigg)
    \quad .
\end{align}
%
The integral in Equation~(\ref{eq:rigid:sTdef}) is therefore just an integral
over $y$:
%
\begin{align}
    \label{eq:rigid:sT}
    \bvec{s}^\top(\mathcal{D}) 
    &=    
    \int\limits_{-\sqrt{1 - x(\mathcal{D})^2}}^
                {\sqrt{1 - x(\mathcal{D})^2}}
    \tilde{\bvec{p}}^\top
    \Big(x(\mathcal{D}), y\Big)
    \mathrm{d}y
    \quad .
\end{align}
%
From \citet{Luger2019}, the $n^\mathrm{th}$ term of the polynomial basis
is a polynomial in $x$, $y$, and $z = \sqrt{1 - x^2 - y^2}$:
%
\begin{proof}{PolynomialBasis}
    \tilde{p}_n 
    &=
    x^i y^j z^k
\end{proof}
%
where $i, j, k$ are integers given by
%
\begin{proof}{PolynomialBasis}
    \label{eq:lm}
    i &= \floor*{\Lambda - \Delta}
    \nonumber \\[0.5em]
    j &= \floor*{\Delta}
    \nonumber \\[0.5em]
    k &= \ceil*{\Delta} - \floor*{\Delta}
\end{proof}
%
with
%
\begin{proof}{PolynomialBasis}
    \Lambda &= \floor*{\sqrt{n}}
    \nonumber \\[0.5em]
    \Delta &= \frac{n - \Lambda^2}{2}
    \quad .
\end{proof}
%
We may now explicitly write down the $n^\mathrm{th}$ term of 
Equation~(\ref{eq:rigid:sT}),
%
\begin{align}
    s_n(\mathcal{D}) 
    &=    
    x(\mathcal{D})^i
    \int\limits_{-\sqrt{1 - x(\mathcal{D})^2}}^
                {\sqrt{1 - x(\mathcal{D})^2}}
        y^j
        \left(1 - x(\mathcal{D})^2 - y^2\right)^{\frac{k}{2}} \,
    \mathrm{d}y 
    \quad ,
\end{align}
%
and solve it analytically:
%
\begin{align}
        \label{eq:rigid:sTAnalytic}
        s_n(\mathcal{D}) 
        &=     
    \begin{dcases}
        0
        &
        \qquad j \, \mathrm{odd}
        \\[1em]
        \frac{2 x(\mathcal{D})^i 
        \big(1 - x(\mathcal{D})^ 2\big)^{\frac{j + 1}{2}}}{j + 1}
        &
        \qquad k = 0
        \\[1em]
        x(\mathcal{D})^{i} \mathcal{I}_{j}
        \big(x(\mathcal{D})\big)
        &
        \qquad k = 1
        \quad ,
    \end{dcases}
\end{align}
%
where $\mathcal{I}_j(x)$ is computed analytically
from the upward recurrence relation given by Equation~(\ref{eq:app:Ij}),
with $\mathcal{I}_0(x)$ given by Equation~(\ref{eq:app:I0}).
%
Figure~\ref{fig:g} shows the $\mathbf{g}$ basis computed from
the formulae above and Equation~(\ref{eq:rigid:gT}) up to spherical 
harmonic degree $l=10$.

\begin{figure}[p!]
    \begin{centering}
    \includegraphics[width=0.6\linewidth]{figures/spot.pdf}
    \oscaption{spot}{%
        Time evolution of a Gaussian absorption line on a rigidly rotating, 
        spotted star computed from the analytic formulae in \S\ref{sec:rigid}.
        The stellar surface is modeled as a spherical harmonic expansion
        up to $l=20$, and the line shape is assumed to be the same everywhere;
        the spot simply downweights the local intensity at all wavelengths.
        As the spot rotates into view (left panel), the line shape changes
        slightly (center panel). The residuals between the line when the
        spot is in view (solid) and when it is on the backside of the star
        (dotted) are shown in the right panel, where
        a Gaussian-like feature can be seen tracking the spot as it rotates
        from the blueshifted hemisphere to the redshifted hemisphere of
        the star.
        \label{fig:spot}
    }
    \end{centering}
\end{figure}

\begin{figure}[h!]
    \begin{centering}
    \includegraphics[width=0.65\linewidth]{figures/compare.pdf}
    \oscaption{compare}{%
        The observed spectrum when the spot is in view computed with
        \starry (blue) and numerically (orange). The problem setup
        is the same as that in Figure~\ref{fig:spot}. The bottom
        panel shows the absolute value of the difference between the 
        two spectra for different grid resolutions in the numerical solution.
        As the number of grid points increases, the numerical solution
        converges to the \starry solution.
        \label{fig:compare}
    }
    \end{centering}
\end{figure}

\begin{figure}[p!]
    \begin{centering}
    \includegraphics[width=0.95\linewidth]{figures/linalg.pdf}
    \oscaption{linalg}{%
        The linear Doppler imaging problem.
        \label{fig:linalg}
    }
    \end{centering}
\end{figure}


%
%
%
%
\appendix
%
%
%
%

\section{Integrals}
\subsection{Equation~(\ref{eq:rigid:sTAnalytic})}
%
When $k = 1$, we may write the $n^\mathrm{th}$ component
of Equation~(\ref{eq:rigid:sTAnalytic}) as
%
\begin{align}
    s_n(\mathcal{D}) = 
        x(\mathcal{D})^{i}
        \mathcal{I}_{j}\big(x(\mathcal{D})\big)
\end{align}
%
where
%
\begin{align}
    \mathcal{I}_j(x) &\equiv
    \int\limits_{-\sqrt{1-x^2}}^{\sqrt{1-x^2}}
        y^{j}
        \sqrt{1 - x^2 - y^2} \,
    \mathrm{d}y
    \quad.
\end{align}
%
Substituting $y = \sin\psi\sqrt{1 - x^2}$, we have
%
\begin{align}
    \mathcal{I}_j(x) &=
    %
    (1 - x^2)^{\frac{j + 2}{2}}
    \int\limits_{-\frac{\pi}{2}}^{\frac{\pi}{2}}
        \sin^j\psi
        \cos^2\psi \,
    \mathrm{d}\psi
    \quad.
\end{align}
%
We may solve this integral using the recurrence relation
%
\begin{align}
    \int
        \sin^j\psi
        \cos^m\psi \,
    \mathrm{d}\psi
    &=
    -\frac{\sin^{j-1}\psi \cos^{m+1}\psi}{j + m}
    +
    \frac{j - 1}{j + m}\int\sin^{j-2}\psi \cos^m\psi \mathrm{d}\psi
    \quad ,
\end{align}
%
which, in our case, simplifies to
%
\begin{align}
    \int\limits_{-\frac{\pi}{2}}^{\frac{\pi}{2}}
        \sin^j\psi
        \cos^2\psi \,
    \mathrm{d}\psi
    &=
    \frac{j - 1}{j + 2}\int\limits_{-\frac{\pi}{2}}^
        {\frac{\pi}{2}}\sin^{j-2}\psi \cos^2\psi \mathrm{d}\psi
    \quad.
\end{align}
%
We thus arrive at the recurrence relation
%
\begin{align}
    \label{eq:app:Ij}
    \mathcal{I}_j(x) &=
    \frac{j - 1}{j + 2}
    (1 - x^2)
    \mathcal{I}_{j-2}(x)
    \quad.
\end{align}
%
Since this expression is only used when $j$ is even, we only need one
initial condition for upward recursion:
%
\begin{align}
    \label{eq:app:I0}
    \mathcal{I}_0(x) &\equiv
    \int\limits_{-\sqrt{1-x^2}}^{\sqrt{1-x^2}}
        \sqrt{1 - x^2 - y^2} \,
    \mathrm{d}y
    \nonumber \\
    &= \frac{\pi}{2}(1 - x^2)
    \quad.
\end{align}

% Bibliography
\bibliography{bib}

\end{document}
